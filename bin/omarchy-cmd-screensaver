#!/bin/bash

# Run the Omarchy screensaver using random effects from TTE.

screensaver_in_focus() {
  hyprctl activewindow -j | jq -e '.class == "org.omarchy.screensaver"' >/dev/null 2>&1
}

exit_screensaver() {
  hyprctl keyword cursor:invisible false
  pkill -x tte 2>/dev/null
  pkill -f org.omarchy.screensaver 2>/dev/null
  exit 0
}

trap exit_screensaver SIGINT SIGTERM SIGHUP SIGQUIT
printf '\e[?1000h\e[?1003h' # Enable mouse tracking (clicks: 1000, movement: 1003)
while read -rsn1 -t 0.1; do :; done # Flush any pending input

printf '\033]11;rgb:00/00/00\007' # Set background color to black

hyprctl keyword cursor:invisible true &>/dev/null

tty=$(tty 2>/dev/null)

# Parse config file
config_file=~/.config/omarchy/branding/screensaver.conf

text=$(grep '^text=' "$config_file" | cut -d '=' -f2- | tr -d '"')

# figlet config
font=$(grep '^font=' "$config_file" | cut -d '=' -f2- | tr -d '"')
figcmd=(figlet)

# Only add the -f argument if font is set
[[ -f "$font" ]] || font="" # Check if font file exists
if [[ -n "$font" ]]; then
  figcmd+=(-f "$font")
fi

while true; do
  effect=$(tte 2>&1 | grep -oP '{\K[^}]+' | tr ',' ' ' | tr ' ' '\n' | sed -n '/^beams$/,$p' | grep -Ev '^(dev_worm)$' | sort -u | shuf -n1)

  if [[ -n "$text" ]] && command -v figlet &>/dev/null; then
    date "+$text" | "${figcmd[@]}" | tte \
      --frame-rate 120 --canvas-width 0 --canvas-height 0 --reuse-canvas --anchor-canvas c --anchor-text c --random-effect --no-eol --no-restore-cursor &
  else
    tte -i ~/.config/omarchy/branding/screensaver.txt \
      --frame-rate 120 --canvas-width 0 --canvas-height 0 --reuse-canvas --anchor-canvas c --anchor-text c --random-effect --no-eol --no-restore-cursor &
  fi

  while pgrep -t "${tty#/dev/}" -x tte >/dev/null; do
    if read -n 1 -t 1 || ! screensaver_in_focus; then
      exit_screensaver
    fi
  done
done
